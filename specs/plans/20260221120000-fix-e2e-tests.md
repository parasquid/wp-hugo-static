# Fix E2E Tests - Single Command Execution

## TL;DR

> Make e2e tests run via single command: `./scripts/run-e2e-tests.sh`
> 
> **Deliverables**: 
> - Updated `run-e2e-tests.sh` script
> - Updated `docker_helper.rb` to not manage containers
> 
> **Estimated Effort**: Short
> **Parallel Execution**: NO - sequential
> **Critical Path**: Script → docker_helper → verify

---

## Context

### Problem
- E2E tests try to start containers from inside builder container (`docker compose exec builder bundle exec rspec`)
- Builder has no docker access → tests fail with "WordPress did not start in time"
- Need: single command to run e2e tests with proper isolation

### Solution
Start containers BEFORE running tests, let script handle the sequence:
1. `docker compose up -d` (start test containers)
2. Wait for WordPress readiness
3. Run e2e tests
4. Cleanup on exit (trap)

---

## Work Objectives

### Core Objective
E2E tests run via single command `./scripts/run-e2e-tests.sh` with proper isolation.

### Concrete Deliverables
- Updated `scripts/run-e2e-tests.sh` that starts containers, runs tests, cleans up
- Updated `scripts/spec/support/docker_helper.rb` that skips container lifecycle
- DRY'd docker-compose files (extract common config, use anchors/extends)

### Definition of Done
- [ ] `./scripts/run-e2e-tests.sh` runs full e2e pipeline
- [ ] Tests pass
- [ ] Containers cleaned up after tests
- [ ] docker-compose files DRY'd (common config extracted)

---

## Execution Strategy

### Tasks

**Task 1**: Update run-e2e-tests.sh

What to do:
- Add container start before tests
- Add wait for WordPress (~90s or health check)
- Add cleanup trap to stop containers on exit
- Keep running tests via `docker compose exec builder bundle exec rspec spec/e2e_spec.rb`

References:
- `scripts/run-e2e-tests.sh` - existing script to update

---

**Task 2**: Update docker_helper.rb to skip container lifecycle

What to do:
- Remove or comment out `before(:all)` that calls `start_test_containers`
- Remove or comment out `after(:all)` that calls `stop_test_containers`
- OR add check: if `test-e2e` containers running, skip start/stop

References:
- `scripts/spec/support/docker_helper.rb` - lines 9-14, 37-38

---

**Task 3**: DRY up docker-compose files

What to do:
- Extract common config (volumes, networks, healthcheck) into base
- Use YAML anchors/extends to reduce duplication between docker-compose.yml and docker-compose.test.yml
- Keep separate files for dev vs test but share common config

References:
- `docker-compose.yml` - main config
- `docker-compose.test.yml` - test config

---

**Task 4**: Verify e2e tests work

What to do:
- Run `./scripts/run-e2e-tests.sh`
- Verify all 8 e2e tests pass
- Verify containers cleaned up after

---

## Commit Strategy
- Message: `fix(e2e): single command e2e test execution + DRY compose`
- Files: `scripts/run-e2e-tests.sh`, `scripts/spec/support/docker_helper.rb`, `docker-compose*.yml`

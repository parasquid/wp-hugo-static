# Baked Comments Feature

## TL;DR

> **Quick Summary**: Fetch GitHub Discussions comments at build time and bake them into static HTML for SEO visibility. Giscus widget remains for interactivity, with JavaScript hiding static comments once Giscus loads.
> 
> **Deliverables**:
> - `scripts/fetch-comments.rb` - Ruby script to fetch GitHub Discussions comments
> - `hugo-site/data/comments/{slug}.json` - JSON files with baked comments
> - `hugo-site/layouts/_default/comments.json.json` - Hugo template to render JSON as HTML
> - Updated `hugo-site/layouts/partials/comments/giscus.html` - Static comments + Giscus + JS hide
> - Updated CI/CD workflow
> 
> **Estimated Effort**: Short
> **Parallel Execution**: NO - sequential (script → data → template → update giscus → workflow)
> **Critical Path**: fetch-comments.rb → JSON data → Hugo template → giscus.html update → CI/CD

---

## Context

### Original Request
User wants to implement "baked comments" feature - make Giscus comments visible to search engines by baking them into the SSG-generated HTML.

### Interview Summary
**Key Discussions**:
- **Per-Post Categories**: Each Hugo post has its own Discussion category in GitHub (user's existing setup)
- **GitHub Token**: Use existing `GITHUB_TOKEN` from workflow secrets
- **Archived Category**: Posts marked "Archived" in WordPress are skipped during fetch. This freezes them in git (no re-fetch), effectively "archived" in the static site. Archived posts have baked comments (static HTML) but NO Giscus widget (read-only, no new comments allowed).
- **Git Persistence**: Root `.git` repo includes hugo-site/content/, so skipped posts remain frozen in markdown files.

**Research Findings**:
- Existing `giscus.html` partial at `hugo-site/layouts/partials/comments/giscus.html`
- CI/CD workflow in `.github/workflows/deploy.yml` already has Ruby setup
- Existing Ruby scripts: `fetch-posts.rb`, `fetch-pages.rb`, `fetch-images.rb` follow consistent patterns
- No existing `hugo-site/data/` directory - will need to create it

---

## Work Objectives

### Core Objective
Bake GitHub Discussions comments into static HTML at build time for SEO, while keeping Giscus widget for interactive commenting.

### Concrete Deliverables
1. `scripts/fetch-comments.rb` - Ruby script to:
   - Query GitHub Discussions via GraphQL API
   - Save comments to `hugo-site/data/comments/{slug}.json`
   - Skip posts with "Archived" category (frozen in git)
2. `scripts/fetch-posts.rb` - Modify to skip posts with "Archived" category
3. Hugo data template to render comments as static HTML
4. Updated `giscus.html` partial with:
   - Static comments HTML (baked from JSON)
   - Giscus widget script
   - JavaScript to hide static comments after Giscus loads
5. CI/CD workflow update to run fetch-comments.rb before Hugo build
6. Update README with new baked comments and archive workflow

### Definition of Done
- [ ] `ruby scripts/fetch-comments.rb` creates `hugo-site/data/comments/` JSON files
- [ ] Hugo builds with static comment HTML in output
- [ ] Giscus widget loads and functions for new comments
- [ ] Static comments hidden after Giscus loads (no duplicate comments visible)
- [ ] CI/CD passes with new step

### Must Have
- Comments visible in source HTML (view-source should show comment content)
- Giscus still functional for new comments
- No duplicate comments visible to users (static hidden after Giscus loads)
- Works with per-post Discussion categories

### Must NOT Have
- Time-based filtering (not needed)
- Duplicate comment display
- Breaking existing Giscus functionality
- Fetching comments for posts that don't exist in Hugo content
- Fetching archived posts (they freeze in git)

---

## Verification Strategy

> **ZERO HUMAN INTERVENTION** — ALL verification is agent-executed.

### Test Decision
- **Infrastructure exists**: YES (Ruby, existing scripts)
- **Automated tests**: None (this is a build-time data fetch)
- **Framework**: N/A

### QA Policy
Every task includes agent-executed QA scenarios.

**Verification Commands**:
```bash
# After script implementation
ruby scripts/fetch-comments.rb
ls -la hugo-site/data/comments/

# After Hugo build
grep -r "baked-comments" hugo-site/public/ || echo "No static comments in output"
grep "giscus" hugo-site/public/ | head -5

# Test locally
cd hugo-site && hugo --minify
```

---

## Execution Strategy

### Sequential Execution (7 tasks)

```
Task 1: Create fetch-comments.rb script ✓ DONE
  ↓
Task 2: Modify fetch-posts.rb to skip archived posts ✓ DONE
  ↓
Task 3: Test fetch-comments.rb (run script, verify JSON created)
  ↓
Task 4: Create Hugo template for rendering comments
  ↓
Task 5: Update giscus.html partial with baked comments + JS
  ↓
Task 6: Update CI/CD workflow
  ↓
Task 7: Update README documentation
```

### Agent Dispatch Summary
- **1**: **1** — T1: fetch-comments.rb script
- **2**: **1** — T2: fetch-posts.rb modification
- **3**: **1** — T3: Test script execution
- **4**: **1** — T4: Hugo template
- **5**: **1** — T5: giscus.html update
- **6**: **1** — T6: CI/CD workflow update
- **7**: **1** — T7: README documentation

---

## TODOs

- [x] 1. Create scripts/fetch-comments.rb

  **What to do**:
  - Create Ruby script following existing patterns (fetch-posts.rb style)
  - Use GitHub GraphQL API to query discussions
  - Match discussions to Hugo post slugs
  - Save comments to `hugo-site/data/comments/{slug}.json`
  - Skip posts with "Archived" category (check post categories in WordPress API)
  - Handle per-post Discussion categories (each post has its own category)

  **Must NOT do**:
  - Create JSON for posts without discussions
  - Create JSON for archived posts

  **Recommended Agent Profile**:
  - **Category**: `quick` (straightforward Ruby script following existing patterns)
    - Reason: Existing fetch-posts.rb provides clear pattern to follow
  - **Skills**: None required beyond Ruby stdlib + JSON
  - **Skills Evaluated but Omitted**:
    - None needed

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Sequential**: First task
  - **Blocks**: Tasks 2-5
  - **Blocked By**: None

  **References**:
  - `scripts/fetch-posts.rb` - Ruby script pattern to follow
  - `scripts/Gemfile` - Existing dependencies (httparty, nokogiri)
  - `.github/workflows/deploy.yml` - How GITHUB_TOKEN is accessed

  **Acceptance Criteria**:
  - [ ] Script runs without errors: `ruby scripts/fetch-comments.rb`
  - [ ] Creates `hugo-site/data/comments/` directory if not exists
  - [ ] JSON files created for posts with open discussions
  - [ ] JSON structure includes: author, body, createdAt, isAnswered

  **QA Scenarios**:

  Scenario: Script runs successfully with valid GitHub token
    Tool: Bash
    Preconditions: GITHUB_TOKEN set in environment
    Steps:
      1. Run `GITHUB_TOKEN=xxx ruby scripts/fetch-comments.rb`
      2. Check exit code is 0
    Expected Result: Script completes without error
    Evidence: Terminal output showing fetched N discussions

  Scenario: Script handles no discussions gracefully
    Tool: Bash
    Preconditions: GitHub repo with no discussions
    Steps:
      1. Run script against empty repo
      2. Check exit code is 0 (not error)
    Expected Result: Script completes gracefully, creates empty directory
    Evidence: Terminal output

  Scenario: Script skips closed discussions
    Tool: Bash
    Preconditions: Mix of open and closed discussions
    Steps:
      1. Run script
      2. Verify no JSON for closed discussions
    Expected Result: Only open discussions have JSON files
    Evidence: File count matches open discussion count

  **Commit**: YES
  - Message: `feat(comments): add fetch-comments.rb script`
  - Files: `scripts/fetch-comments.rb`

---

- [x] 3. Test fetch-comments.rb execution (requires Ruby runtime - test locally)

  **What to do**:
  - Run the script with actual GitHub token
  - Verify JSON files are created correctly
  - Validate JSON structure

  **Must NOT do**:
  - Leave test artifacts in repo

  **Recommended Agent Profile**:
  - **Category**: `quick` - Verification task
  - **Skills**: None

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Sequential**: After Task 1
  - **Blocks**: Task 3
  - **Blocked By**: Task 1

  **References**:
  - Task 1 output

  **Acceptance Criteria**:
  - [ ] JSON files created in hugo-site/data/comments/
  - [ ] Each JSON has valid structure

  **QA Scenarios**:

  Scenario: Verify JSON structure
    Tool: Bash
    Preconditions: Task 1 complete
    Steps:
      1. `cat hugo-site/data/comments/*.json | head -50`
      2. Validate each has required fields
    Expected Result: Valid JSON with author, body, createdAt

  **Commit**: NO (part of Task 1)

---

- [x] 2. Modify scripts/fetch-posts.rb to skip archived posts

  **What to do**:
  - Read existing `scripts/fetch-posts.rb`
  - Add check for "Archived" category in WordPress post
  - Skip posts with "Archived" category (don't fetch/update them)
  - This freezes them in git - they won't be re-fetched from WordPress

  **Must NOT do**:
  - Break existing fetch functionality for non-archived posts

  **Recommended Agent Profile**:
  - **Category**: `quick` - Simple modification to existing script
  - **Skills**: None

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Sequential**: After Task 1
  - **Blocks**: None (can run in parallel with Task 3)
  - **Blocked By**: None

  **References**:
  - `scripts/fetch-posts.rb` - Existing script to modify

  **Acceptance Criteria**:
  - [ ] Archived posts are skipped during fetch
  - [ ] Non-archived posts are fetched normally

  **QA Scenarios**:

  Scenario: Verify archived posts are skipped
    Tool: Bash
    Preconditions: WordPress has archived post
    Steps:
      1. Run fetch-posts.rb
      2. Check that archived post markdown is not updated
    Expected Result: Archived post unchanged

  **Commit**: YES
  - Message: `feat(archive): skip archived posts in fetch`
  - Files: `scripts/fetch-posts.rb`

---

- [x] 4. Create Hugo template for static comments

  **What to do**:
  - Create `hugo-site/layouts/_default/comments.json.json` to render JSON as HTML
  - Template should output semantic HTML for comments
  - Include author name, avatar (if available), date, body

  **Must NOT do**:
  - Break existing JSON API functionality

  **Recommended Agent Profile**:
  - **Category**: `quick` - Hugo template following existing patterns
  - **Skills**: None

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Sequential**: After Task 2
  - **Blocks**: Task 4
  - **Blocked By**: Task 2

  **References**:
  - `hugo-site/layouts/partials/comments/giscus.html` - Existing pattern

  **Acceptance Criteria**:
  - [ ] Hugo can render the template: `cd hugo-site && hugo --printJsonData`
  - [ ] Output is valid HTML fragment

  **QA Scenarios**:

  Scenario: Template renders valid HTML
    Tool: Bash
    Preconditions: Task 2 complete, data exists
    Steps:
      1. Check if Hugo can render with the data
    Expected Result: No errors

  **Commit**: YES
  - Message: `feat(comments): add Hugo template for static comments`
  - Files: `hugo-site/layouts/_default/comments.json.json`

---

- [x] 5. Update giscus.html partial with baked comments + JS

  **What to do**:
  - Read existing `hugo-site/layouts/partials/comments/giscus.html`
  - Add static comments HTML (from data/comments/{slug}.json)
  - Add JavaScript to hide static comments once Giscus loads
  - Keep Giscus widget for new comments

  **Must NOT do**:
  - Break Giscus functionality
  - Show duplicate comments to users

  **Recommended Agent Profile**:
  - **Category**: `quick` - Template update following existing patterns
  - **Skills**: None

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Sequential**: After Task 3
  - **Blocks**: Task 5
  - **Blocked By**: Task 3

  **References**:
  - `hugo-site/layouts/partials/comments/giscus.html` - Existing file to modify

  **Acceptance Criteria**:
  - [ ] Static comments visible in page source (view-source)
  - [ ] Giscus widget still loads
  - [ ] Static comments hidden after Giscus loads (JS check)

  **QA Scenarios**:

  Scenario: Verify static comments in output HTML
    Tool: Bash
    Preconditions: Hugo build with new partial
    Steps:
      1. `grep -o "baked-comment" hugo-site/public/posts/*/index.html | head -10`
    Expected Result: Static comment markup found

  Scenario: Verify Giscus still works
    Tool: Bash
    Preconditions: Hugo build
    Steps:
      1. `grep "giscus.app" hugo-site/public/posts/*/index.html | head -5`
    Expected Result: Giscus script tag found

  **Commit**: YES
  - Message: `feat(comments): add baked static comments to giscus partial`
  - Files: `hugo-site/layouts/partials/comments/giscus.html`

---

- [x] 6. Update CI/CD workflow

  **What to do**:
  - Add `ruby fetch-comments.rb` step to `.github/workflows/deploy.yml`
  - Run after `ruby fetch-pages.rb` and before Hugo build
  - Use existing Ruby setup (already in workflow)

  **Must NOT do**:
  - Break existing workflow
  - Add unnecessary steps

  **Recommended Agent Profile**:
  - **Category**: `quick` - Simple workflow update
  - **Skills**: None

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Sequential**: After Task 4
  - **Blocks**: None
  - **Blocked By**: Task 4

  **References**:
  - `.github/workflows/deploy.yml` - Existing workflow

  **Acceptance Criteria**:
  - [ ] Workflow syntax valid
  - [ ] New step runs fetch-comments.rb

  **QA Scenarios**:

  Scenario: Workflow syntax valid
    Tool: Bash
    Steps:
      1. `cat .github/workflows/deploy.yml | python3 -c "import yaml,sys; yaml.safe_load(sys.stdin)"`
    Expected Result: Valid YAML, no parse errors

  **Commit**: YES
  - Message: `feat(comments): add fetch-comments to CI/CD workflow`
  - Files: `.github/workflows/deploy.yml`

---

- [x] 7. Update README documentation

  **What to do**:
  - Read existing `README.md`
  - Add section explaining baked comments feature:
    - How baked comments work (fetch at build time, bake to static HTML)
    - How to archive posts (add "Archived" category in WordPress)
    - Archived behavior: baked comments visible, no Giscus widget (read-only)
  - Document the fetch-comments.rb script usage
  - Update file structure if needed

  **Must NOT do**:
  - Remove existing documentation
  - Break existing README formatting

  **Recommended Agent Profile**:
  - **Category**: `writing` - Documentation update
  - **Skills**: None

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Sequential**: After Task 5
  - **Blocks**: None
  - **Blocked By**: Task 5

  **References**:
  - `README.md` - Existing documentation to update

  **Acceptance Criteria**:
  - [ ] README mentions baked comments feature
  - [ ] Archive workflow documented
  - [ ] Archived behavior explained (read-only)

  **QA Scenarios**:

  Scenario: README updated
    Tool: Bash
    Preconditions: Task 5 complete
    Steps:
      1. `grep -i "baked" README.md`
      2. `grep -i "archive" README.md`
    Expected Result: Both terms found in README

  **Commit**: YES
  - Message: `docs: add baked comments and archive workflow to README`
  - Files: `README.md`

---

## Final Verification Wave

- [ ] F1. **Plan Compliance Audit** — `oracle`
  Read the plan end-to-end. For each "Must Have": verify implementation exists. For each "Must NOT Have": search for forbidden patterns.
  Output: `Must Have [N/N] | Must NOT Have [N/N] | Tasks [N/N] | VERDICT: APPROVE/REJECT`

- [ ] F2. **Code Quality Review** — `unspecified-high`
  Review all new files for: Ruby syntax, Hugo template syntax, valid JSON output, no console.log.
  Output: `Ruby [OK/ERRORS] | Templates [OK/ERRORS] | JSON [OK/ERRORS] | VERDICT`

- [ ] F3. **Real Manual QA** — `unspecified-high`
  Run full build locally. Verify: static comments in HTML source, Giscus loads, static hidden after load.
  Output: `Static Comments [VISIBLE/HIDDEN] | Giscus [LOADS/NOT] | JS Hide [WORKS/NOT] | VERDICT`

- [ ] F4. **Scope Fidelity Check** — `deep`
  Verify: all 6 tasks done, no extra work beyond scope, no creep.
  Output: `Tasks [7/7] | Scope [CLEAN/CREEP] | VERDICT`

---

## Commit Strategy

- **Task 1**: `feat(comments): add fetch-comments.rb script` - scripts/fetch-comments.rb
- **Task 2**: `feat(archive): skip archived posts in fetch` - scripts/fetch-posts.rb
- **Task 4**: `feat(comments): add Hugo template for static comments` - hugo-site/layouts/_default/comments.json.json
- **Task 5**: `feat(comments): add baked static comments to giscus partial` - hugo-site/layouts/partials/comments/giscus.html
- **Task 6**: `docs: add baked comments and archive workflow to README` - README.md

---

## Success Criteria

### Verification Commands
```bash
# Test fetch script
ruby scripts/fetch-comments.rb
ls hugo-site/data/comments/

# Build and verify
cd hugo-site && hugo --minify

# Check output
grep -c "baked-comment" hugo-site/public/posts/*/index.html
grep "giscus.app" hugo-site/public/posts/*/index.html | wc -l
```

### Final Checklist
- [ ] All 7 tasks completed
- [ ] Static comments visible in page source
- [ ] Giscus widget functional
- [ ] Static comments hidden after Giscus loads
- [ ] CI/CD workflow updated
- [ ] All commits created

# Draft: End-to-End Test Script

## Requirements (confirmed)
- Create an end-to-end test script that encodes the testing workflow
- Test should go through the complete pipeline: WordPress → Fetch → Hugo Build → Verify

## Current Testing Workflow (from docs/testing.md and README.md)

### Phase 1: Service Startup
1. `docker compose up -d wordpress db builder`
2. Verify containers are running

### Phase 2: WordPress Initialization (first-time setup)
1. Install WP-CLI in WordPress container
2. Install WordPress core
3. Create application password for API access

### Phase 3: Content Seeding
1. Run `ensure-archived-category.rb` - creates Archived category
2. Run `seed-posts.rb` - creates test posts (regular + archived)
3. (Optional) Run `seed-discussions.rb` - creates GitHub Discussions for comments

### Phase 4: Content Fetching
1. Run `fetch-posts.rb` - WordPress posts → Hugo Markdown
2. Run `fetch-pages.rb` - WordPress pages → Hugo Markdown
3. Run `fetch-images.rb` - Downloads and processes images
4. Run `fetch-comments.rb` - Fetches GitHub Discussions → baked JSON

### Phase 5: Hugo Build
1. `hugo -s /app/hugo-site --minify`
2. Output to `hugo-site/public/`

### Phase 6: Verification
1. Check output files exist in `hugo-site/public/posts/`
2. Check archived posts have `archived: true` frontmatter
3. Check regular posts have correct structure

## Available Scripts
| Script | Purpose |
|--------|---------|
| `ensure-archived-category.rb` | Creates "Archived" category in WordPress |
| `seed-posts.rb` | Creates test posts (2 regular, 1 archived) |
| `seed-discussions.rb` | Creates GitHub Discussions for testing comments |
| `fetch-posts.rb` | Fetches WordPress posts → Hugo Markdown |
| `fetch-pages.rb` | Fetches WordPress pages → Hugo Markdown |
| `fetch-images.rb` | Downloads and processes images |
| `fetch-comments.rb` | Fetches GitHub Discussions → baked JSON |
| `generate-watermark.rb` | Generates watermark for images |

## Environment Variables Required
- `WP_API_URL` - WordPress REST API URL (use `http://wordpress` inside Docker)
- `WP_USERNAME` - WordPress admin username
- `WP_APPLICATION_PASSWORD` - WordPress application password
- `GITHUB_TOKEN` - GitHub PAT for Discussions (optional, for comments testing)
- `GITHUB_REPO` - GitHub repo for Discussions (optional)

## Technical Decisions

### Script Language
- **RSpec with rspec-given**: Structured testing with describe/context/it blocks, given for test data setup, nice formatted output

### Comments Testing
- **Mock baked comments**: Create test JSON files directly in `hugo-site/data/comments/` instead of fetching from GitHub
- Avoids needing real GITHUB_TOKEN
- Makes tests deterministic

### Test Isolation
- **Project name namespacing**: Use `COMPOSE_PROJECT_NAME=test-` to create separate containers/volumes
- Same docker-compose.yml, just namespaced differently
- No duplication of configuration

### Test Modes
- **Full integration test**: WordPress init → seed → fetch → build → verify (for CI)
- **Fetch-to-build test**: Assume WordPress seeded, test fetch → build → verify (for local dev iteration, faster)

### RSpec Structure
- **Per-component specs**: fetch_posts_spec.rb, fetch_images_spec.rb, hugo_build_spec.rb
- **E2E spec**: Full pipeline integration test
- Both structures for comprehensive coverage

### Cleanup
- **Full cleanup**: Reset WordPress content, clear Hugo output, remove test posts
- Idempotent - safe to run multiple times
- Isolated from dev environment via project namespacing

### Verification
- **Comprehensive**:
  - Output files exist in hugo-site/public/posts/
  - Frontmatter correct (title, date, slug, archived flag)
  - Archived posts have `archived: true`
  - Hugo build succeeds with no errors
  - Images processed correctly

## Scope Boundaries
- INCLUDE: Docker services, WordPress setup, content seeding, fetching, Hugo build, verification, RSpec tests
- INCLUDE: Mock comments data
- EXCLUDE: Cloudflare deployment (requires live credentials)
- EXCLUDE: GitHub Discussions API (mocked instead)
